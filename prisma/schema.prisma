// Propi MVP Schema
// Simplified for initial testing with TowerHomes

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================
// AGENTS & AUTHENTICATION
// ============================================

model Agent {
  id              String   @id @default(cuid())
  email           String   @unique
  phone           String
  passwordHash    String
  name            String
  prcLicense      String   @unique
  photo           String?
  bio             String?  @db.Text
  headline        String?
  yearsExperience Int?
  socialLinks     Json?
  areasServed     String[] // ["Baguio City", "La Trinidad", "Benguet"]
  specializations String[] // ["Residential", "Commercial", "Land"]
  defaultSplit    Decimal  @default(50) // Default co-broke split %
  isActive        Boolean  @default(true)

  // Relations
  listings          Property[]
  receivedInquiries Inquiry[]      @relation("ReceivedInquiries")
  sentInquiries     Inquiry[]      @relation("SentInquiries")
  conversations1    Conversation[] @relation("Participant1")
  conversations2    Conversation[] @relation("Participant2")
  sentMessages      Message[]
  propertyViews     PropertyView[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([prcLicense])
}

// ============================================
// PROPERTIES & LISTINGS
// ============================================

model Property {
  id      String @id @default(cuid())
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id])

  // Basic Info
  title           String
  description     String          @db.Text
  aiDescription   String?         @db.Text
  propertyType    PropertyType
  transactionType TransactionType

  // Pricing
  price       Decimal
  pricePerSqm Decimal?

  // Location
  province  String
  city      String
  barangay  String?
  address   String?
  landmark  String?
  latitude  Decimal?
  longitude Decimal?

  // Specifications
  bedrooms  Int?
  bathrooms Int?
  carpark   Int?
  lotArea   Decimal?
  floorArea Decimal?
  floors    Int?
  yearBuilt Int?

  // Features
  features   String[]
  furnishing Furnishing?

  // Media
  photos   String[] // URLs from R2/S3
  videoUrl String?

  // Co-Brokerage
  allowCoBroke Boolean @default(true)
  coBrokeSplit Decimal @default(50) // % to selling agent

  // Status
  status     PropertyStatus @default(DRAFT)
  isFeatured Boolean        @default(false)
  viewCount  Int            @default(0)

  // AI/Search - pgvector embedding
  embedding  Unsupported("vector(1536)")?
  embeddedAt DateTime?

  // Relations
  inquiries     Inquiry[]
  conversations Conversation[]
  views         PropertyView[]
  favorites     Favorite[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([agentId])
  @@index([status])
  @@index([propertyType])
  @@index([transactionType])
  @@index([province, city])
  @@index([price])
}

enum PropertyType {
  HOUSE
  CONDO
  TOWNHOUSE
  APARTMENT
  LOT
  COMMERCIAL
  WAREHOUSE
  FARM
}

enum TransactionType {
  SALE
  RENT
}

enum PropertyStatus {
  DRAFT
  AVAILABLE
  RESERVED
  SOLD
  RENTED
  UNLISTED
}

enum Furnishing {
  UNFURNISHED
  SEMI_FURNISHED
  FULLY_FURNISHED
}

// ============================================
// INQUIRIES & LEADS
// ============================================

model Inquiry {
  id               String        @id @default(cuid())
  propertyId       String
  property         Property      @relation(fields: [propertyId], references: [id])
  agentId          String
  agent            Agent         @relation("ReceivedInquiries", fields: [agentId], references: [id])
  name             String
  email            String
  phone            String?
  message          String        @db.Text
  status           InquiryStatus @default(NEW)
  notes            String?       @db.Text
  inquiringAgentId String?
  inquiringAgent   Agent?        @relation("SentInquiries", fields: [inquiringAgentId], references: [id])
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  contactedAt      DateTime?

  @@index([propertyId])
  @@index([agentId])
  @@index([status])
}

enum InquiryStatus {
  NEW
  CONTACTED
  VIEWING_SCHEDULED
  NEGOTIATING
  CONVERTED
  CLOSED
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id             String    @id @default(cuid())
  participant1Id String
  participant1   Agent     @relation("Participant1", fields: [participant1Id], references: [id])
  participant2Id String
  participant2   Agent     @relation("Participant2", fields: [participant2Id], references: [id])
  propertyId     String?
  property       Property? @relation(fields: [propertyId], references: [id])
  lastMessageAt  DateTime?
  messages       Message[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([participant1Id, participant2Id, propertyId])
  @@index([participant1Id])
  @@index([participant2Id])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         Agent        @relation(fields: [senderId], references: [id])
  content        String       @db.Text
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// ============================================
// PUBLIC USERS (BUYERS)
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?  // Optional for social login
  name         String?
  phone        String?
  photo        String?

  // Preferences
  preferredLocations String[]
  preferredTypes     PropertyType[]
  minBudget          Decimal?
  maxBudget          Decimal?

  // Relations
  favorites     Favorite[]
  savedSearches SavedSearch[]
  propertyViews PropertyView[] @relation("UserViews")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}

model SavedSearch {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  query     Json     // Stores search parameters
  alertsOn  Boolean  @default(true)
  lastAlert DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ============================================
// ANALYTICS
// ============================================

model PropertyView {
  id         String   @id @default(cuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  viewerId   String?
  viewer     Agent?   @relation(fields: [viewerId], references: [id])
  userId     String?
  user       User?    @relation("UserViews", fields: [userId], references: [id])
  viewedAt   DateTime @default(now())
  referrer   String?

  @@index([propertyId, viewedAt])
  @@index([userId])
}
