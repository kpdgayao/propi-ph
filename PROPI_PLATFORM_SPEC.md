# Propi Platform — Technical Specification

> AI-Powered Real Estate Co-Brokerage Platform for the Philippines
> 
> **Domain:** propi.ph
> **Owner:** IOL Inc.
> **First Client:** TowerHomes (Baguio City)

---

## Table of Contents

1. [Project Overview](#project-overview)
2. [Business Model](#business-model)
3. [Tech Stack](#tech-stack)
4. [Project Structure](#project-structure)
5. [Database Schema](#database-schema)
6. [API Routes](#api-routes)
7. [AI Features](#ai-features)
8. [Authentication](#authentication)
9. [Core Features](#core-features)
10. [Environment Variables](#environment-variables)
11. [Development Phases](#development-phases)
12. [Deployment](#deployment)
13. [Scripts & Commands](#scripts--commands)

---

## Project Overview

### What is Propi?

Propi is a mobile-first real estate co-brokerage platform that enables:

- **Agents** to list properties and find co-brokerage opportunities
- **Agents** to manage inquiries, viewings, and deals through a lite CRM
- **Buyers/Renters** to discover properties with AI-powered matching
- **Brokerages** to track transactions and commissions

### Key Differentiators

1. **AI-First:** Listing descriptions generated by AI, semantic property search, natural language property matching
2. **Co-Brokerage Native:** Built for commission splitting between listing and selling agents
3. **Regional Focus:** Starting with Northern Luzon (Baguio, Benguet, La Union, Pangasinan)
4. **Success-Based Revenue:** Platform only earns when deals close

### Target Users

| User Type | Description |
|-----------|-------------|
| **Licensed Agents** | PRC-licensed real estate brokers and salespersons |
| **Brokerage Admins** | TowerHomes staff managing the agent network |
| **Buyers/Renters** | Property seekers (Phase 2) |
| **IOL Admin** | Platform owner managing multiple brokerages |

---

## Business Model

### Commission Structure

Standard Philippine real estate: **5% total commission** on sale price

```
┌─────────────────────────────────────────────────────┐
│  Selling Agent (found the buyer)           55%     │
│  Listing Agent (listed the property)       30%     │
│  Brokerage Admin (TowerHomes)               8%     │
│  Platform Fee (IOL/Propi)                   7%     │
└─────────────────────────────────────────────────────┘
```

**Example:** ₱10M property sale = ₱500K commission
- Selling Agent: ₱275,000
- Listing Agent: ₱150,000
- TowerHomes: ₱40,000
- Propi (IOL): ₱35,000

### Revenue Streams

| Stream | Description | Rate |
|--------|-------------|------|
| Platform Fee | % of commission on closed deals | 7% of total commission |
| Premium Features | Featured listings, analytics (future) | ₱500-2,000/month |
| Ancillary Services | Valuation, loan referrals (future) | Per transaction |

### IP Ownership

- **IOL Inc.** owns 100% of platform IP
- Brokerages are **licensed tenants**, not owners
- Platform can be licensed to multiple brokerages nationwide

---

## Tech Stack

### Core Technologies

| Layer | Technology | Notes |
|-------|------------|-------|
| Framework | Next.js 15 (App Router) | Server components, API routes |
| Language | TypeScript (strict mode) | Full type safety |
| Styling | Tailwind CSS | Utility-first |
| UI Components | shadcn/ui + Radix UI | Accessible, customizable |
| Database | PostgreSQL + pgvector | Railway hosted |
| ORM | Prisma | Type-safe queries |
| Auth | JWT (jose) + bcryptjs | Stateless authentication |

### AI & Search

| Service | Technology | Purpose |
|---------|------------|---------|
| LLM | Claude API (claude-sonnet-4-5-20250514) | Description generation, property matching |
| Embeddings | OpenAI text-embedding-3-small | 1536 dimensions, semantic search |
| Vector Search | pgvector | PostgreSQL extension |

### External Services

| Service | Provider | Purpose |
|---------|----------|---------|
| Hosting | Railway | App + Database |
| Email | Mailjet | Transactional emails |
| SMS | Semaphore | Philippine SMS gateway |
| Maps | Google Maps API | Property locations, map view |
| Payments | PayMongo | Future premium features |
| Automation | n8n | Workflows (self-hosted on Railway) |
| Storage | Cloudflare R2 or AWS S3 | Property photos |

### Development Tools

| Tool | Purpose |
|------|---------|
| pnpm | Package manager |
| ESLint | Linting |
| Prettier | Code formatting |
| Prisma Studio | Database GUI |
| Railway CLI | Deployment |

---

## Project Structure

```
propi/
├── app/                          # Next.js App Router
│   ├── (auth)/                   # Public auth pages
│   │   ├── login/
│   │   ├── register/
│   │   ├── verify-email/
│   │   └── forgot-password/
│   ├── (dashboard)/              # Protected agent pages
│   │   ├── dashboard/            # Agent home
│   │   ├── listings/             # Property management
│   │   │   ├── page.tsx          # My listings
│   │   │   ├── new/              # Create listing
│   │   │   └── [id]/             # Edit listing
│   │   ├── discover/             # Property search
│   │   │   ├── page.tsx          # Search & filters
│   │   │   ├── map/              # Map view
│   │   │   └── [id]/             # Property detail
│   │   ├── inquiries/            # CRM pipeline
│   │   │   ├── page.tsx          # Kanban/list view
│   │   │   └── [id]/             # Inquiry detail
│   │   ├── viewings/             # Viewing calendar
│   │   ├── deals/                # Closed transactions
│   │   ├── chat/                 # AI property matcher
│   │   ├── earnings/             # Commission tracker
│   │   └── settings/             # Profile & preferences
│   ├── (public)/                 # Public pages (Phase 2)
│   │   ├── properties/           # Public listing view
│   │   └── search/               # Public search
│   ├── admin/                    # Brokerage admin
│   │   ├── dashboard/
│   │   ├── agents/
│   │   ├── transactions/
│   │   └── reports/
│   └── api/                      # API routes
│       ├── auth/
│       │   ├── register/route.ts
│       │   ├── login/route.ts
│       │   ├── logout/route.ts
│       │   └── verify-email/route.ts
│       ├── agents/
│       │   ├── route.ts          # GET list, POST create
│       │   ├── [id]/route.ts     # GET, PATCH, DELETE
│       │   └── me/route.ts       # Current agent profile
│       ├── listings/
│       │   ├── route.ts          # GET list, POST create
│       │   ├── [id]/route.ts     # GET, PATCH, DELETE
│       │   └── [id]/photos/route.ts
│       ├── inquiries/
│       │   ├── route.ts
│       │   ├── [id]/route.ts
│       │   └── [id]/activities/route.ts
│       ├── viewings/
│       │   ├── route.ts
│       │   └── [id]/route.ts
│       ├── deals/
│       │   ├── route.ts
│       │   └── [id]/route.ts
│       ├── search/
│       │   └── route.ts          # Semantic search
│       ├── ai/
│       │   ├── generate-description/route.ts
│       │   └── match-properties/route.ts
│       └── webhooks/
│           └── paymongo/route.ts
├── components/
│   ├── ui/                       # shadcn/ui components
│   ├── shared/                   # Common components
│   │   ├── page-header.tsx
│   │   ├── empty-state.tsx
│   │   ├── loading-state.tsx
│   │   └── error-state.tsx
│   ├── listings/                 # Listing components
│   │   ├── listing-card.tsx
│   │   ├── listing-form.tsx
│   │   ├── listing-gallery.tsx
│   │   └── listing-map.tsx
│   ├── inquiries/                # CRM components
│   │   ├── inquiry-card.tsx
│   │   ├── inquiry-pipeline.tsx
│   │   └── activity-timeline.tsx
│   ├── chat/                     # AI chat components
│   │   ├── chat-interface.tsx
│   │   ├── chat-message.tsx
│   │   └── property-suggestion.tsx
│   └── maps/                     # Map components
│       ├── property-map.tsx
│       └── map-marker.tsx
├── lib/
│   ├── db.ts                     # Prisma client singleton
│   ├── auth.ts                   # JWT utilities
│   ├── password.ts               # bcrypt hashing
│   ├── embeddings.ts             # OpenAI embeddings
│   ├── claude.ts                 # Claude API client
│   ├── vector-search.ts          # pgvector queries
│   ├── email.ts                  # Mailjet integration
│   ├── sms.ts                    # Semaphore integration
│   ├── storage.ts                # R2/S3 uploads
│   ├── maps.ts                   # Google Maps utilities
│   ├── commission.ts             # Commission calculations
│   ├── validations.ts            # Zod schemas
│   └── utils.ts                  # Helper functions
├── types/
│   └── index.ts                  # TypeScript definitions
├── prisma/
│   ├── schema.prisma             # Database schema
│   ├── migrations/               # Migration files
│   └── seed.ts                   # Seed data
├── scripts/
│   ├── seed-agents.ts            # Seed TowerHomes agents
│   ├── embed-listings.ts         # Generate embeddings for all listings
│   └── compute-commissions.ts    # Batch commission calculation
├── public/
│   ├── logo.svg
│   └── og-image.png
├── docs/                         # Documentation
├── n8n-workflows/                # Automation workflows
├── .env.example
├── .env.local                    # Local environment (git-ignored)
├── CLAUDE.md                     # Claude Code instructions
├── README.md
├── package.json
└── tsconfig.json
```

---

## Database Schema

### Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ============================================
// AGENTS & AUTHENTICATION
// ============================================

model Agent {
  id                String    @id @default(cuid())
  email             String    @unique
  phone             String
  passwordHash      String
  name              String
  prcLicense        String    @unique
  prcVerified       Boolean   @default(false)
  prcVerifiedAt     DateTime?
  photo             String?
  bio               String?   @db.Text
  brokerageId       String?
  brokerage         Brokerage? @relation(fields: [brokerageId], references: [id])
  areasServed       String[]  // ["Baguio City", "La Trinidad", "Benguet"]
  specializations   String[]  // ["Residential", "Commercial", "Land", "Condo"]
  defaultSplit      Decimal   @default(50)  // Default co-broke split %
  role              AgentRole @default(AGENT)
  isActive          Boolean   @default(true)
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  lastLoginAt       DateTime?
  
  // Relations
  listings          Property[]
  inquiriesAsListing Inquiry[] @relation("ListingAgent")
  inquiriesAsBuyer  Inquiry[]  @relation("BuyerAgent")
  viewings          Viewing[]
  activities        Activity[]
  chatSessions      ChatSession[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([brokerageId])
  @@index([prcLicense])
  @@index([email])
}

enum AgentRole {
  AGENT           // Regular agent
  BROKER          // Licensed broker (can have agents under)
  BROKERAGE_ADMIN // Brokerage staff
  PLATFORM_ADMIN  // IOL staff
}

model Brokerage {
  id          String    @id @default(cuid())
  name        String    // "TowerHomes"
  slug        String    @unique // "towerhomes"
  logo        String?
  address     String?
  phone       String?
  email       String?
  website     String?
  adminFeePercent Decimal @default(8)  // Brokerage cut from commission
  isActive    Boolean   @default(true)
  
  agents      Agent[]
  properties  Property[]
  deals       Deal[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// PROPERTIES & LISTINGS
// ============================================

model Property {
  id              String          @id @default(cuid())
  agentId         String
  agent           Agent           @relation(fields: [agentId], references: [id])
  brokerageId     String?
  brokerage       Brokerage?      @relation(fields: [brokerageId], references: [id])
  
  // Basic Info
  title           String
  description     String          @db.Text
  aiDescription   String?         @db.Text  // AI-generated description
  propertyType    PropertyType
  transactionType TransactionType
  
  // Pricing
  price           Decimal
  pricePerSqm     Decimal?        // Computed for comparison
  
  // Location
  province        String
  city            String
  barangay        String?
  address         String?         // Full address (private until inquiry)
  landmark        String?         // Nearby landmark for directions
  latitude        Decimal?
  longitude       Decimal?
  
  // Specifications
  bedrooms        Int?
  bathrooms       Int?
  carpark         Int?
  lotArea         Decimal?        // in sqm
  floorArea       Decimal?        // in sqm
  floors          Int?
  yearBuilt       Int?
  
  // Features & Amenities
  features        String[]        // ["Swimming Pool", "Garden", "Security"]
  furnishing      Furnishing?
  
  // Media
  photos          String[]        // URLs from R2/S3
  videoUrl        String?         // YouTube/Vimeo embed
  virtualTourUrl  String?         // Matterport etc.
  
  // Co-Brokerage Settings
  allowCoBroke    Boolean         @default(true)
  coBrokeSplit    Decimal         @default(50)  // % to selling agent
  
  // Status
  status          PropertyStatus  @default(AVAILABLE)
  isFeatured      Boolean         @default(false)
  viewCount       Int             @default(0)
  inquiryCount    Int             @default(0)
  
  // AI/Search
  embedding       Unsupported("vector(1536)")?
  embeddedAt      DateTime?
  
  // Relations
  inquiries       Inquiry[]
  viewings        Viewing[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  publishedAt     DateTime?
  soldAt          DateTime?

  @@index([agentId])
  @@index([brokerageId])
  @@index([status])
  @@index([propertyType])
  @@index([transactionType])
  @@index([province, city])
  @@index([price])
}

enum PropertyType {
  HOUSE
  CONDO
  TOWNHOUSE
  APARTMENT
  LOT
  COMMERCIAL
  WAREHOUSE
  FARM
  RESORT
}

enum TransactionType {
  SALE
  RENT
}

enum PropertyStatus {
  DRAFT
  AVAILABLE
  RESERVED
  SOLD
  RENTED
  UNLISTED
}

enum Furnishing {
  UNFURNISHED
  SEMI_FURNISHED
  FULLY_FURNISHED
}

// ============================================
// CRM: INQUIRIES & PIPELINE
// ============================================

model Inquiry {
  id              String        @id @default(cuid())
  
  // Property & Agents
  propertyId      String?
  property        Property?     @relation(fields: [propertyId], references: [id])
  listingAgentId  String
  listingAgent    Agent         @relation("ListingAgent", fields: [listingAgentId], references: [id])
  buyerAgentId    String?       // Co-broke agent who found the buyer
  buyerAgent      Agent?        @relation("BuyerAgent", fields: [buyerAgentId], references: [id])
  
  // Buyer Info
  buyerName       String
  buyerPhone      String
  buyerEmail      String?
  buyerNotes      String?       @db.Text  // Initial message from buyer
  
  // Source Tracking
  source          InquirySource @default(APP)
  sourceDetails   String?       // e.g., "Facebook Ad Campaign X"
  
  // Pipeline
  stage           InquiryStage  @default(NEW)
  stageChangedAt  DateTime      @default(now())
  priority        Priority      @default(MEDIUM)
  
  // Follow-up
  nextFollowUp    DateTime?
  lastContactedAt DateTime?
  
  // Qualification (future: AI-generated)
  budget          Decimal?
  timeline        String?       // "Immediate", "1-3 months", "6+ months"
  financing       String?       // "Cash", "Bank Loan", "Pag-IBIG"
  aiSummary       String?       @db.Text  // AI qualification summary
  
  // Relations
  viewings        Viewing[]
  activities      Activity[]
  deal            Deal?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([listingAgentId])
  @@index([buyerAgentId])
  @@index([propertyId])
  @@index([stage])
  @@index([nextFollowUp])
}

enum InquirySource {
  APP
  WEBSITE
  FACEBOOK
  REFERRAL
  WALKIN
  PHONE
  OTHER
}

enum InquiryStage {
  NEW
  CONTACTED
  QUALIFIED
  VIEWING_SCHEDULED
  VIEWED
  NEGOTIATING
  RESERVED
  CLOSED_WON
  CLOSED_LOST
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Activity {
  id          String       @id @default(cuid())
  inquiryId   String
  inquiry     Inquiry      @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  agentId     String?
  agent       Agent?       @relation(fields: [agentId], references: [id])
  type        ActivityType
  content     String       @db.Text
  metadata    Json?        // Additional data (e.g., old/new stage for stage changes)
  createdAt   DateTime     @default(now())

  @@index([inquiryId])
  @@index([agentId])
}

enum ActivityType {
  NOTE
  CALL
  SMS
  EMAIL
  WHATSAPP
  STAGE_CHANGE
  VIEWING_SCHEDULED
  VIEWING_COMPLETED
  DOCUMENT_UPLOADED
  SYSTEM
}

// ============================================
// VIEWINGS & CALENDAR
// ============================================

model Viewing {
  id              String        @id @default(cuid())
  inquiryId       String
  inquiry         Inquiry       @relation(fields: [inquiryId], references: [id], onDelete: Cascade)
  propertyId      String
  property        Property      @relation(fields: [propertyId], references: [id])
  agentId         String
  agent           Agent         @relation(fields: [agentId], references: [id])
  
  // Scheduling
  scheduledAt     DateTime
  duration        Int           @default(60)  // minutes
  
  // Status
  status          ViewingStatus @default(SCHEDULED)
  
  // Reminders
  reminderSentAt  DateTime?
  confirmedAt     DateTime?
  
  // Post-Viewing
  feedback        String?       @db.Text
  buyerInterest   Interest?
  completedAt     DateTime?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([inquiryId])
  @@index([propertyId])
  @@index([agentId])
  @@index([scheduledAt])
  @@index([status])
}

enum ViewingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  NO_SHOW
  CANCELLED
  RESCHEDULED
}

enum Interest {
  NOT_INTERESTED
  MAYBE
  INTERESTED
  VERY_INTERESTED
}

// ============================================
// DEALS & COMMISSIONS
// ============================================

model Deal {
  id                  String      @id @default(cuid())
  inquiryId           String      @unique
  inquiry             Inquiry     @relation(fields: [inquiryId], references: [id])
  brokerageId         String?
  brokerage           Brokerage?  @relation(fields: [brokerageId], references: [id])
  
  // Transaction Details
  transactionValue    Decimal     // Final sale/rent price
  transactionType     TransactionType
  
  // Commission Breakdown
  commissionRate      Decimal     @default(5)    // Total commission %
  totalCommission     Decimal                    // Computed
  
  listingAgentShare   Decimal                    // Amount to listing agent
  sellingAgentShare   Decimal?                   // Amount to co-broke (if any)
  brokerageShare      Decimal                    // Amount to brokerage
  platformShare       Decimal                    // Amount to Propi/IOL
  
  // Split Configuration (for audit)
  listingAgentPercent Decimal     @default(30)
  sellingAgentPercent Decimal     @default(55)
  brokeragePercent    Decimal     @default(8)
  platformPercent     Decimal     @default(7)
  
  // Status
  status              DealStatus  @default(PENDING)
  
  // Payment Tracking
  paymentDueDate      DateTime?
  paidAt              DateTime?
  paymentReference    String?
  
  // Documents (future)
  documents           Json?       // [{name, url, type}]
  
  // Timestamps
  closedAt            DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([brokerageId])
  @@index([status])
  @@index([closedAt])
}

enum DealStatus {
  PENDING           // Deal recorded, awaiting documents
  PROCESSING        // Documents submitted, commission being processed
  COMPLETED         // Commission paid out
  CANCELLED         // Deal fell through
  DISPUTED          // Commission dispute
}

// ============================================
// AI CHAT SESSIONS
// ============================================

model ChatSession {
  id          String    @id @default(cuid())
  agentId     String
  agent       Agent     @relation(fields: [agentId], references: [id])
  type        ChatType
  title       String?   // Auto-generated from first message
  messages    Json      // [{role: "user"|"assistant", content, timestamp}]
  metadata    Json?     // Context: propertyId, inquiryId, etc.
  isArchived  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([agentId])
  @@index([type])
}

enum ChatType {
  PROPERTY_SEARCH     // "Find me properties for my buyer"
  LISTING_ASSIST      // "Help me write this listing"
  GENERAL             // General questions
}
```

### pgvector Setup

Run this SQL after database creation:

```sql
-- Enable pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Create index for faster similarity search (after data exists)
CREATE INDEX IF NOT EXISTS property_embedding_idx 
ON "Property" 
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

---

## API Routes

### Authentication

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/auth/register` | Register new agent |
| POST | `/api/auth/login` | Login, returns JWT |
| POST | `/api/auth/logout` | Clear auth cookie |
| POST | `/api/auth/verify-email` | Verify email token |
| POST | `/api/auth/forgot-password` | Request password reset |
| POST | `/api/auth/reset-password` | Reset password with token |
| GET | `/api/auth/me` | Get current agent profile |

### Agents

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/agents` | List agents (admin) |
| GET | `/api/agents/[id]` | Get agent by ID |
| PATCH | `/api/agents/[id]` | Update agent profile |
| GET | `/api/agents/me` | Current agent profile |
| PATCH | `/api/agents/me` | Update own profile |

### Listings

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/listings` | List properties (with filters) |
| POST | `/api/listings` | Create new listing |
| GET | `/api/listings/[id]` | Get listing detail |
| PATCH | `/api/listings/[id]` | Update listing |
| DELETE | `/api/listings/[id]` | Delete listing |
| POST | `/api/listings/[id]/photos` | Upload photos |
| DELETE | `/api/listings/[id]/photos/[photoId]` | Delete photo |
| POST | `/api/listings/[id]/publish` | Publish listing |
| POST | `/api/listings/[id]/unlist` | Unlist property |

### Search

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/search` | Semantic property search |
| POST | `/api/search/embed` | Generate embedding for query |

### Inquiries

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/inquiries` | List inquiries (with filters) |
| POST | `/api/inquiries` | Create inquiry |
| GET | `/api/inquiries/[id]` | Get inquiry detail |
| PATCH | `/api/inquiries/[id]` | Update inquiry |
| POST | `/api/inquiries/[id]/stage` | Change pipeline stage |
| GET | `/api/inquiries/[id]/activities` | Get activity timeline |
| POST | `/api/inquiries/[id]/activities` | Add activity |

### Viewings

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/viewings` | List viewings (calendar) |
| POST | `/api/viewings` | Schedule viewing |
| GET | `/api/viewings/[id]` | Get viewing detail |
| PATCH | `/api/viewings/[id]` | Update viewing |
| POST | `/api/viewings/[id]/confirm` | Confirm viewing |
| POST | `/api/viewings/[id]/complete` | Mark completed + feedback |
| POST | `/api/viewings/[id]/cancel` | Cancel viewing |

### Deals

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/deals` | List deals |
| POST | `/api/deals` | Create deal from inquiry |
| GET | `/api/deals/[id]` | Get deal detail |
| PATCH | `/api/deals/[id]` | Update deal |
| POST | `/api/deals/[id]/complete` | Mark deal completed |

### AI

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/ai/generate-description` | Generate listing description |
| POST | `/api/ai/match-properties` | Chat-based property matching |

---

## AI Features

### 1. Listing Description Generator

**Endpoint:** `POST /api/ai/generate-description`

**Input:**
```typescript
{
  propertyType: "HOUSE",
  transactionType: "SALE",
  price: 8500000,
  province: "Benguet",
  city: "Baguio City",
  barangay: "Camp 7",
  bedrooms: 3,
  bathrooms: 2,
  lotArea: 200,
  floorArea: 150,
  features: ["Mountain View", "Garden", "Garage"],
  furnishing: "SEMI_FURNISHED"
}
```

**Prompt Template:**
```typescript
const prompt = `You are a Filipino real estate copywriter specializing in Northern Luzon properties.

Generate a compelling property listing description for:

Property: ${propertyType} for ${transactionType}
Location: ${barangay ? barangay + ', ' : ''}${city}, ${province}
Price: ₱${price.toLocaleString()}
Size: ${lotArea} sqm lot, ${floorArea} sqm floor area
Bedrooms: ${bedrooms} | Bathrooms: ${bathrooms}
Features: ${features.join(', ')}
Furnishing: ${furnishing}

Requirements:
1. Write in English with warm, professional tone
2. Highlight location advantages specific to ${city}
3. Emphasize features that appeal to buyers (investment value, lifestyle)
4. Include a call-to-action
5. Keep it 150-200 words
6. Do NOT include price in the description (shown separately)
7. Do NOT use generic phrases like "Don't miss this opportunity"

Return ONLY the description text, no titles or labels.`;
```

**Output:** Plain text description

### 2. Semantic Property Search

**Endpoint:** `GET /api/search?q={query}`

**Implementation:**
```typescript
// lib/vector-search.ts
import { openai } from './openai';
import { prisma } from './db';

export async function searchProperties(query: string, limit = 10) {
  // Generate embedding for search query
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: query,
  });
  
  const embedding = response.data[0].embedding;
  
  // Search with pgvector
  const results = await prisma.$queryRaw`
    SELECT 
      id, 
      title, 
      price, 
      city, 
      province,
      bedrooms,
      bathrooms,
      "propertyType",
      photos,
      1 - (embedding <=> ${embedding}::vector) as similarity
    FROM "Property"
    WHERE status = 'AVAILABLE'
      AND embedding IS NOT NULL
    ORDER BY embedding <=> ${embedding}::vector
    LIMIT ${limit}
  `;
  
  return results;
}
```

### 3. AI Property Matcher (Chat)

**Endpoint:** `POST /api/ai/match-properties`

**Implementation:**
```typescript
// RAG: Search → Context → Generate

export async function matchProperties(
  query: string, 
  sessionId?: string
) {
  // 1. Semantic search for relevant properties
  const properties = await searchProperties(query, 5);
  
  // 2. Build context from search results
  const context = properties.map(p => `
**${p.title}**
- Price: ₱${p.price.toLocaleString()}
- Location: ${p.city}, ${p.province}
- Type: ${p.propertyType}
- Specs: ${p.bedrooms}BR, ${p.bathrooms}BA
- ID: ${p.id}
  `).join('\n---\n');
  
  // 3. Generate response with Claude
  const response = await anthropic.messages.create({
    model: 'claude-sonnet-4-5-20250514',
    max_tokens: 1024,
    system: `You are Propi, an AI property assistant for Northern Luzon real estate.

Your job is to help agents find properties for their buyers. You have access to current listings.

Guidelines:
- Be helpful, concise, and specific
- Reference actual properties from the context provided
- Explain WHY each property fits (or doesn't fit) the buyer's needs
- If no properties match well, say so honestly
- Use Filipino real estate context (mention landmarks, accessibility, investment potential)
- Always include property IDs so agents can view full details`,
    messages: [
      {
        role: 'user',
        content: `Available listings:\n${context}\n\n---\n\nBuyer request: "${query}"\n\nRecommend the best matches and explain why.`
      }
    ]
  });
  
  return {
    message: response.content[0].text,
    properties: properties,
    sessionId: sessionId
  };
}
```

### 4. Embedding Generation

**Trigger:** On property create/update

```typescript
// lib/embeddings.ts
import { openai } from './openai';
import { prisma } from './db';

export async function embedProperty(propertyId: string) {
  const property = await prisma.property.findUnique({
    where: { id: propertyId }
  });
  
  if (!property) throw new Error('Property not found');
  
  // Create text representation for embedding
  const text = `
    ${property.propertyType} for ${property.transactionType} 
    in ${property.barangay || ''} ${property.city}, ${property.province}.
    Price: ${property.price} pesos.
    ${property.bedrooms} bedrooms, ${property.bathrooms} bathrooms.
    Lot area: ${property.lotArea} sqm. Floor area: ${property.floorArea} sqm.
    Features: ${property.features.join(', ')}.
    ${property.description}
  `.trim();
  
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: text,
  });
  
  const embedding = response.data[0].embedding;
  
  // Store embedding
  await prisma.$executeRaw`
    UPDATE "Property" 
    SET embedding = ${embedding}::vector, 
        "embeddedAt" = NOW()
    WHERE id = ${propertyId}
  `;
  
  return { success: true };
}
```

---

## Authentication

### JWT-Based Auth (Same as CAT Platform)

```typescript
// lib/auth.ts
import { SignJWT, jwtVerify } from 'jose';
import { cookies } from 'next/headers';

const JWT_SECRET = new TextEncoder().encode(process.env.JWT_SECRET);

export interface JWTPayload {
  agentId: string;
  email: string;
  role: string;
  brokerageId?: string;
}

export async function signToken(payload: JWTPayload): Promise<string> {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt()
    .setExpirationTime('7d')
    .sign(JWT_SECRET);
}

export async function verifyToken(token: string): Promise<JWTPayload | null> {
  try {
    const { payload } = await jwtVerify(token, JWT_SECRET);
    return payload as JWTPayload;
  } catch {
    return null;
  }
}

export async function getSession(): Promise<JWTPayload | null> {
  const cookieStore = await cookies();
  const token = cookieStore.get('auth_token')?.value;
  if (!token) return null;
  return verifyToken(token);
}

export async function requireAuth(): Promise<JWTPayload> {
  const session = await getSession();
  if (!session) {
    throw new Error('Unauthorized');
  }
  return session;
}
```

### Password Hashing

```typescript
// lib/password.ts
import bcrypt from 'bcryptjs';

export async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, 12);
}

export async function verifyPassword(
  password: string, 
  hash: string
): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

### Middleware

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { verifyToken } from './lib/auth';

const publicPaths = [
  '/login',
  '/register',
  '/verify-email',
  '/forgot-password',
  '/reset-password',
  '/api/auth',
];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // Allow public paths
  if (publicPaths.some(path => pathname.startsWith(path))) {
    return NextResponse.next();
  }
  
  // Check auth token
  const token = request.cookies.get('auth_token')?.value;
  
  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
  
  const payload = await verifyToken(token);
  
  if (!payload) {
    const response = NextResponse.redirect(new URL('/login', request.url));
    response.cookies.delete('auth_token');
    return response;
  }
  
  // Check admin routes
  if (pathname.startsWith('/admin')) {
    if (!['BROKERAGE_ADMIN', 'PLATFORM_ADMIN'].includes(payload.role)) {
      return NextResponse.redirect(new URL('/dashboard', request.url));
    }
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|logo.svg).*)',
  ],
};
```

---

## Core Features

### MVP Feature Checklist

#### Phase 1: Foundation (Weeks 1-2)
- [ ] Project setup (Next.js, Prisma, Railway)
- [ ] Database schema + pgvector extension
- [ ] Agent registration with PRC license
- [ ] Email verification (Mailjet)
- [ ] JWT authentication
- [ ] Agent profile management

#### Phase 2: Listings (Weeks 3-5)
- [ ] Create listing form
- [ ] Photo upload (R2/S3)
- [ ] **AI description generator** ← Key feature
- [ ] My listings view
- [ ] Edit/delete listing
- [ ] Publish/unlist flow

#### Phase 3: Discovery (Weeks 6-7)
- [ ] Property search with filters
- [ ] Map view (Google Maps)
- [ ] Embedding generation on publish
- [ ] **Semantic search** ← Key feature
- [ ] Property detail page
- [ ] Co-brokerage indicators

#### Phase 4: CRM (Weeks 8-10)
- [ ] Inquiry capture form
- [ ] Pipeline view (Kanban)
- [ ] Activity timeline
- [ ] Stage transitions
- [ ] Follow-up reminders

#### Phase 5: Viewings (Week 11)
- [ ] Schedule viewing
- [ ] Agent calendar view
- [ ] SMS reminders (Semaphore)
- [ ] Complete with feedback

#### Phase 6: Deals (Week 12)
- [ ] Create deal from inquiry
- [ ] Commission computation
- [ ] Deal pipeline
- [ ] Basic reporting

#### Phase 7: AI Chat (Weeks 13-14)
- [ ] **Property matcher chat** ← Key feature
- [ ] Chat history
- [ ] Conversation UI

#### Phase 8: Polish (Week 15)
- [ ] PWA setup
- [ ] Error handling
- [ ] Loading states
- [ ] Mobile optimization
- [ ] Performance tuning

---

## Environment Variables

```bash
# .env.example

# ============================================
# DATABASE
# ============================================
DATABASE_URL="postgresql://user:password@host:5432/propi_db"

# ============================================
# AUTHENTICATION
# ============================================
JWT_SECRET="your-secret-key-minimum-32-characters-long"
NEXTAUTH_URL="http://localhost:3000"

# ============================================
# AI SERVICES
# ============================================
OPENAI_API_KEY="sk-..."
ANTHROPIC_API_KEY="sk-ant-api03-..."

# ============================================
# EMAIL (Mailjet)
# ============================================
MAILJET_API_KEY="your-mailjet-api-key"
MAILJET_SECRET_KEY="your-mailjet-secret-key"
MAILJET_SENDER_EMAIL="noreply@propi.ph"
MAILJET_SENDER_NAME="Propi"

# ============================================
# SMS (Semaphore)
# ============================================
SEMAPHORE_API_KEY="your-semaphore-api-key"
SEMAPHORE_SENDER_NAME="PROPI"

# ============================================
# STORAGE (Cloudflare R2)
# ============================================
R2_ACCOUNT_ID="your-account-id"
R2_ACCESS_KEY_ID="your-access-key"
R2_SECRET_ACCESS_KEY="your-secret-key"
R2_BUCKET_NAME="propi-uploads"
R2_PUBLIC_URL="https://uploads.propi.ph"

# ============================================
# GOOGLE MAPS
# ============================================
NEXT_PUBLIC_GOOGLE_MAPS_KEY="your-google-maps-api-key"

# ============================================
# PAYMENTS (PayMongo) - Future
# ============================================
PAYMONGO_SECRET_KEY="sk_test_..."
PAYMONGO_PUBLIC_KEY="pk_test_..."

# ============================================
# APPLICATION
# ============================================
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_APP_NAME="Propi"
NODE_ENV="development"
```

---

## Deployment

### Railway Setup

1. **Create Railway Project**
   ```bash
   railway login
   railway init
   ```

2. **Add PostgreSQL with pgvector**
   - Use Railway's PostgreSQL template
   - After provisioning, run:
   ```sql
   CREATE EXTENSION IF NOT EXISTS vector;
   ```

3. **Environment Variables**
   - Add all variables from `.env.example`
   - Railway auto-injects `DATABASE_URL`

4. **Deploy**
   ```bash
   railway up
   ```

### Railway Services

| Service | Purpose | Notes |
|---------|---------|-------|
| `propi-web` | Next.js app | Main application |
| `propi-db` | PostgreSQL + pgvector | Database |
| `propi-n8n` | n8n automation | Optional, for workflows |

### Production Checklist

- [ ] Enable SSL on Railway
- [ ] Set `NODE_ENV=production`
- [ ] Configure custom domain (propi.ph)
- [ ] Set up Cloudflare for CDN
- [ ] Enable error monitoring (Sentry)
- [ ] Set up database backups
- [ ] Configure rate limiting

---

## Scripts & Commands

```bash
# Development
pnpm dev                    # Start dev server
pnpm build                  # Production build
pnpm start                  # Start production server
pnpm lint                   # Run ESLint
pnpm format                 # Format with Prettier

# Database
pnpm prisma:generate        # Generate Prisma client
pnpm prisma:push            # Push schema to DB
pnpm prisma:migrate         # Run migrations
pnpm prisma:studio          # Open Prisma Studio
pnpm prisma:seed            # Seed database

# Custom Scripts
pnpm seed:agents            # Seed TowerHomes agents
pnpm embed:all              # Generate embeddings for all listings
pnpm compute:commissions    # Batch commission calculation

# Deployment
railway up                  # Deploy to Railway
railway logs                # View logs
```

---

## Coding Conventions

### File Naming
- Components: `PascalCase.tsx` (e.g., `ListingCard.tsx`)
- Utilities: `kebab-case.ts` (e.g., `vector-search.ts`)
- API routes: `route.ts`

### Component Structure
```typescript
// components/listings/listing-card.tsx
import { Property } from '@prisma/client';
import { formatPrice } from '@/lib/utils';

interface ListingCardProps {
  property: Property;
  showCoBroke?: boolean;
}

export function ListingCard({ property, showCoBroke = true }: ListingCardProps) {
  // Implementation
}
```

### API Route Structure
```typescript
// app/api/listings/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/db';
import { requireAuth } from '@/lib/auth';
import { z } from 'zod';

const createListingSchema = z.object({
  title: z.string().min(10),
  // ... validation
});

export async function POST(request: NextRequest) {
  try {
    const session = await requireAuth();
    const body = await request.json();
    const data = createListingSchema.parse(body);
    
    const listing = await prisma.property.create({
      data: {
        ...data,
        agentId: session.agentId,
      },
    });
    
    return NextResponse.json(listing, { status: 201 });
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: 'Validation failed', details: error.errors },
        { status: 400 }
      );
    }
    console.error('Create listing error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

### Error Handling
- Use Zod for input validation
- Return consistent error responses
- Log errors with context
- Never expose internal errors to clients

---

## References

- [Next.js 15 Docs](https://nextjs.org/docs)
- [Prisma Docs](https://www.prisma.io/docs)
- [pgvector](https://github.com/pgvector/pgvector)
- [shadcn/ui](https://ui.shadcn.com)
- [Claude API](https://docs.anthropic.com)
- [OpenAI Embeddings](https://platform.openai.com/docs/guides/embeddings)
- [Railway Docs](https://docs.railway.app)
- [Mailjet API](https://dev.mailjet.com)
- [Semaphore SMS](https://semaphore.co/docs)
- [PayMongo API](https://developers.paymongo.com)

---

## Contact

**IOL Inc.**
- Kevin Philip D. Gayao, CEO
- Baguio City, Philippines

**First Client:** TowerHomes
- Mark Dulag, Owner
- Baguio City, Philippines

---

*Last updated: January 2026*
